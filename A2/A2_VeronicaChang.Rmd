---
title: "BCB420 Assignment 2: Differential Gene Expression Analysis and Preliminary ORA"
author: "Veronica Chang"
date: "February 14th, 2023"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: paged
editor_options: 
  markdown: 
    wrap: sentence
bibliography: a2.bib
---
# Introduction

## Background

## Objectives

## Dataset

## Previous Analysis

## Packages
* [BiocManager](https://CRAN.R-project.org/package=BiocManager) [@morgan2022]
* [GEOmetadb](https://bioconductor.org/packages/release/bioc/html/GEOmetadb.html) [@zhu2008]
* [limma](https://bioconductor.org/packages/release/bioc/html/limma.html) [@smyth2015]
* [edgeR](https://bioconductor.org/packages/release/bioc/html/edgeR.html) [@robinson2010]
* [biomaRt](https://bioconductor.org/packages/release/bioc/html/biomaRt.html) [@durinck2009]
* [GEOquery](https://bioconductor.org/packages/release/bioc/html/GEOquery.html) [@davis2007]
* [Biobase](https://bioconductor.org/packages/release/bioc/html/Biobase.html) [@huber2015]
* [RColorBrewer](https://cran.r-project.org/package=RColorBrewer) [@neuwirth2022]
```{r, message=FALSE, warning=FALSE}

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if (!requireNamespace("GEOmetadb", quietly = TRUE))
    BiocManager::install("GEOmetadb")

library("BiocManager")
library("GEOmetadb")
library("limma")
library("edgeR")
library("dplyr")
library("Biobase")
library("biomaRt")
library("GEOquery")
library("ComplexHeatmap")
library("circlize")
library("RColorBrewer")
library("ggplot2")
library("knitr")
library("RSQLite")
library("kableExtra")
```

# Task 1: Differential Gene Expression
## Import data
For our analysis in A1, we saved our data output to a .csv file. We will need to load the data file to use in our analysis for this assignment.
```{r message = FALSE, tidy=TRUE, warning=FALSE}
# Load the data file
counts <- read.csv(file = "~/projects/expDataNorm.csv", header = TRUE, row.names = 1)

# View some of the data
head(counts)

# Also loaded in the samples categories into a table
expSamples <- read.csv("~/projects/expSamples.csv", header = TRUE)
```
**Table 1.** First few rows of a table of the normalized data counts of the chosen gene set. There are `r nrow(counts)` genes from `r ncol(counts)` samples. Each gene has a unique HGNC symbol identifier. The samples can be divided into (1) `patient_group`, MS and CON, where MS includes the multiple sclerosis donor samples and CON is the non-neurological control donors, (2) `tissue`, GM and WM, where GM includes grey matter samples and WM includes white matter samples.


## Design model
We will be using the package `edgeR` for this assignment. edgeR uses a generalized linear model to test for differential expression of RNA-seq expression profiles. We need to consider how there are two major factors in our data set - `patient_group` and `tissue`. Ideally, we would account for both in our design model.

```{r message = FALSE, tidy=TRUE, warning=FALSE}
# Define the groups 
groups <- paste(expSamples$patient_group, expSamples$tissue,sep = ".")
groups <- factor(groups)

# Create design with groups 
modelDesign <- model.matrix(~0 + groups)
DT::datatable(modelDesign[order(gsub("M[0-9]{2}\\.", "", rownames(modelDesign))), ], 
              rownames = TRUE,
              options = list(pageLength = 5, scrollX = TRUE)) %>%
              DT::formatStyle(names(modelDesign), fontSize = "10px")

```
**Table 2.** Differential expression analysis model design, includes both `patient_group` and `tissue` as factors. 

Since we are using `edgeR` for downstream analysis, we will first need to create a DGEList object, this will hold the dataset that will be analyzed by edgeR. We will also evaluate the dispersion. We will be using a Quasi-likelihood model as our dataset is of RNA-Seq data and Quasi-likelihood models are best suited. However, Quasi-likelihood models require that the data follows a negative binomial distribution.

```{r message = FALSE, tidy=TRUE, warning=FALSE}
# Create DGEList
dgeCounts <- edgeR::DGEList(counts = counts, group = groups)

# Check dispersion 
dgeCounts <- edgeR::estimateDisp(dgeCounts, modelDesign)

edgeR::plotMeanVar(dgeCounts,
                   show.raw.vars = TRUE,
                   show.tagwise.vars = TRUE,
                   NBline = TRUE,
                   show.ave.raw.vars = TRUE,
                   show.binned.common.disp.vars = TRUE,
                   main = "Mean-Variance Plot for Normalized Data")
```
**Figure 1.** Mean-variance relationship of normalized data. Dispersion estimation is done with the negative binomial model, which estimates the common, trended and tagwise dispersions across all tags. The grey and light blue points show the mean and pooled variance for each gene. The red crosses show binned variance, in which genes are grouped by mean level. The blue line indicates the common dispersion and is based on the negative binomial model. The black line displays the theoretical variance under the Poisson distribution model where the variance is equal to the mean. 

In order to make accurate inferences about differential expression, we need to appropriately model the mean-variance relationship in DGEs. As we can see in Fig. 1, our normalized data set follows the negative binomial distribution. We can now verify that we can use a Quasi-likelihood model and fit our data to our model.

## Fit the data
```{r message = FALSE, tidy=TRUE, warning=FALSE}
fit <- edgeR::glmQLFit(dgeCounts, modelDesign)
```

We have now fit our model and can move to differential expression analysis.

## MS vs CON
We will be testing for differential expression between the MS and CON samples.
```{r message = FALSE, tidy=TRUE, warning=FALSE}

```
## Global gene expression
We can now generate a heat map, this is a data graph that will allow us to visualize global expression change over many samples. 

```{r message = FALSE, tidy=TRUE, warning=FALSE}
# First, as we have two groups for two factors, annotating the heat map will make it easier to read. 
# In A1, I already defined a colour scheme for the groups, as below:
colTissue <- as.factor(expSamples$tissue)
colTissue <- c("grey", "white")[colTissue]
colPatient <- as.factor(expSamples$patient_group)
colPatient <- c("forestgreen", "dodgerblue")[colPatient]

# This is another one for a combination of tissue and patient_group, group
colGroup <- as.factor(expSamples$group)
levels(colGroup) <-  brewer.pal(nlevels(colGroup), "Spectral")
colGroup <- as.character(colGroup)

# Creating an annotation data frame
dfAnnotation <- data.frame(tissue = countsMatrix$tissue,
                      patient_group = countsMatrix$patient_group)
colAnnotation <- list(tissue = colTissue, patient_group = colPatient)

# Heat map annotation
hmapAnnotation <- ComplexHeatmap::HeatmapAnnotation(
                    df = dfAnnotation,
                    col = colAnnotation)

```

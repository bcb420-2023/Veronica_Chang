---
title: "BCB420 Assignment 1: Data set selection and initial processing"
author: "Veronica Chang"
date: "r Sys.Date()"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: paged
editor_options: 
  markdown: 
    wrap: sentence
---

# Task 1: Install packages and select an expression data set

## Packages

```{r, message=FALSE, warning=FALSE}

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if (!requireNamespace("GEOmetadb", quietly = TRUE))
    BiocManager::install("GEOmetadb")

library("BiocManager")
library("GEOmetadb")
library("limma")
library("edgeR")
library("dplyr")
library("Biobase")
library("biomaRt")
library("GEOmetadb")
library("GEOquery")
library("RColorBrewer")
library("ggplot2")
library("knitr")
library("RSQLite")
library("kableExtra")
```


## Prepare the database

```{r, message=FALSE, tidy=TRUE}
# Check if it already exists
if(!file.exists('GEOmetadb.sqlite')) GEOmetadb::getSQLiteFile()
file.info('GEOmetadb.sqlite')

# Connect to the database
con <- DBI::dbConnect(RSQLite::SQLite(),'GEOmetadb.sqlite',`synchronous` = NULL)
DBI::dbListFields(con, 'gpl')
geoTables <- DBI::dbListTables(con)
geoTables
```


##Query the database.

I am looking for series related to the human autoimmune disease, lupus or SLE.
Therefore, the organims should contain `Homo sapiens` and the title of the series should contain one of `autoimmune`, `lupus`.
Technology should be `Highthroughoutput RNA sequencing` and was submitted within the past `10 years`.

```{r, message=FALSE, tidy=TRUE}
results <- DBI::dbGetQuery(con,'select * from gpl limit 5')
knitr::kable(head(results[,1:5]), format = "pipe")

# Build the SQL query
sql <- paste("SELECT DISTINCT gse.title, gse.gse, gpl.title,",
             " gse.submission_date,",
             " gse.supplementary_file",
             "FROM",
             "  gse JOIN gse_gpl ON gse_gpl.gse=gse.gse",
             "  JOIN gpl ON gse_gpl.gpl=gpl.gpl",
             "WHERE",
             "  gpl.organism LIKE '%Homo sapiens%' AND",
             "  gse.title LIKE '%lupus%' OR gse.title LIKE '%multiple sclerosis%' AND",
             "  gpl.technology LIKE '%high-throughput sequencing%' AND",
             "  gse.submission_date > '2013-01-01'",
             "  ORDER BY gse.submission_date DESC",
             sep=" ")

# Initiate the query
rs <- DBI::dbGetQuery(con,sql)
knitr::kable(rs, format = "pipe")
dim(rs)
```

### Selected the dataset **GSE111972**, description below
```{r, message=FALSE, tidy=TRUE}
gseAccession <- "GSE111972"
gse <- GEOquery::getGEO(gseAccession, GSEMatrix = FALSE)
gpl <- names(GEOquery::GPLList(gse))[1]
gplInfo <- GEOquery::Meta(GEOquery::getGEO(gpl))
```


# Task 2: Clean the data and map to HUGO symbols

## Fetch the data set

```{r, message=FALSE, tidy=TRUE}
gseDir <- "/home/rstudio/projects/A1"
if (! file.exists("~/projects/A1/GSE111972/GSE111972_norm_data.txt")) {
  sFiles = GEOquery::getGEOSuppFiles(gseAccession)
  fName = rownames(sFiles)
  GEOquery::gunzip(fNames[1])
}
```

There is only one supplemental file for this study.

```{r, tidy=TRUE}
file <- list.files(path = "~/projects/A1/GSE111972/", pattern = "\\.txt")
expData <- read.table(paste0("~/projects/A1/GSE111972/", file), sep = "\t", 
                        header = TRUE, check.names = FALSE)
colnames(expData)[2:32] <- sub("Sample_", "", colnames(expData))[2:32]
dim(expData)
```

There are 32 columns, the first being the Gene ID. There are 21283 rows (genes) in this data set.

## Define the groups

```{r, tidy=TRUE}
samples <- data.frame(lapply(colnames(expData)[2:32], 
        FUN=function(x){unlist(strsplit(x, 
                        split = "\\_"))[c(1,2,3)]}))
colnames(samples) <- sub("Sample_", "", colnames(expData))[2:32]
rownames(samples) <- c("patients_group","tissue","replicate")
samples <- data.frame(t(samples))
samples
```

##Check for gene duplicates

```{r, tidy=TRUE}
length(unique(expData$ID))
!(length(unique(expData$ID)) == dim(expData)[1]) 
```

There are no gene duplicates. 

## Remove lowly expressed genes

```{r, message= FALSE, tidy=TRUE}
cpms = cpm(expData[,2:32])
rownames(cpms) <- expData[,1]

# get rid of low counts
keep = rowSums(cpms >1) >=10
expDataFiltered = expData[keep,]
```

## Identifier mapping

### Building a Biomart Query

```{r, message= FALSE, tidy=TRUE}
listMarts()
ensembl <- useMart("ensembl")
datasets <- listDatasets(ensembl)
knitr::kable(head(datasets),format = "html")

knitr::kable(head(datasets[grep(datasets$dataset,
                  pattern = "sapiens"),]),format = "html")
ensembl <- useDataset("hsapiens_gene_ensembl",mart=ensembl)
dim(listFilters(ensembl))

knitr::kable(listFilters(ensembl)[1:10,1:2], type="html")
biomart_human_filters <- listFilters(ensembl)
```

### Attributes 

```{r, message= FALSE, tidy=TRUE}
kable(searchAttributes(mart = ensembl, 'hgnc') , format="html") %>%
  row_spec(2, background = "yellow")

httr::set_config(httr::config(ssl_verifypeer = FALSE))
ensembl <- biomaRt::useMart("ensembl", dataset="hsapiens_gene_ensembl")
```

### Check

```{r, message= FALSE, tidy=TRUE}
conversion_stash <- "geneIDConversion.rds"
if (file.exists(conversion_stash)) {
  geneIDConversion <- readRDS(conversion_stash)
} else {
  geneIDConversion <- biomaRt::getBM(attributes = "hgnc_symbol",
                                  filters = "hgnc_symbol",
                                  values = expDataFiltered$ID,
                                  mart = ensembl)
  saveRDS(geneIDConversion, conversion_stash)
}

#find the genes that do not use HGNC annotation
not_hgnc <- expDataFiltered[-(which(rownames(keep) %in% geneIDConversion$hgnc_symbol)), ]
```

Seems like all genes are already annotated with HGNC symbols.

# Task 3: Apply Normalization

## Check statistical summaries

```{r, message = FALSE, tidy=TRUE, warning=FALSE}
summaryStats <- data.frame(apply(expDataFiltered[, 2:32], 2, summary))
summaryStats

# Calculate the summary statistics for each group

# CON (non-neurological control) WM (white matter)
summaryCONWM <- summary(rowMeans(expDataFiltered[, grep("CON_WM", colnames(expDataFiltered))]))
# MS (multiple sclerosis) WM (white matter)
summaryMSWM <- summary(rowMeans(expDataFiltered[, grep("MS_WM", colnames(expDataFiltered))]))
# CON (non-neurological control) GM (grey matter)
summaryCONGM <- summary(rowMeans(expDataFiltered[, grep("CON_GM", colnames(expDataFiltered))]))
# MS (multiple sclerosis) GM (grey matter)
summaryMSGM <- summary(rowMeans(expDataFiltered[, grep("MS_GM", colnames(expDataFiltered))]))

# Combine all
summaryStats2 <- rbind(summaryCONWM, summaryMSWM, summaryCONGM, summaryMSGM)
rownames(summaryStats2) <- c("CON WM", "MS WM", "CON GM", "MS GM")
knitr::kable(summaryStats2, format = "html", col.names = colnames(summaryStats2)) 
```


Means of the different groups are similar to each other for each tissue. This suggests that variations in gene counts can be attributed to biological variations rather than technical variations.


## Check distribution
```{r, message = FALSE, tidy=TRUE, warning=FALSE}
tissueGroup <- as.factor(samples$tissue)
tissueGroup <- c("grey", "white")[tissueGroup]
patientGroup <- as.factor(samples$patients_group)
patientGroup <- c("forestgreen", "dodgerblue")[patientGroup]

# box plot
data2plot <- log2(cpm(expDataFiltered[,2:32]))
boxplot(data2plot, xlab = "Samples", ylab = "log2 CPM", 
        las = 2, cex = 0.5, cex.lab = 0.5, col = patientGroup,
        cex.axis = 0.5, main = "Greyâ€“white matter of multiple sclerosis patients 
        and non-neurological control donors")

# draw the median on each box plot
abline(h = median(apply(data2plot, 2, median)), 
       col = "red", lwd = 0.6, lty = "dashed")

# density plot
counts_density <- apply(log2(cpm(expDataFiltered[,3:32])), 
                        2, density)

# calculate  limits
  xlim <- 0; ylim <- 0
  for (i in 1:length(counts_density)) {
    xlim <- range(c(xlim, counts_density[[i]]$x)); 
    ylim <- range(c(ylim, counts_density[[i]]$y))
  }
  cols <- rainbow(length(counts_density))
  ltys <- rep(1, length(counts_density))
  
# plot the first density plot to initialize 
plot(counts_density[[1]], xlim=xlim, ylim=ylim, type="n", 
     ylab="Smoothing density of log2-CPM", 
     main="", cex.lab = 0.85)

# plot the lines
for (i in 1:length(counts_density)) 
  lines(counts_density[[i]], col=cols[i], lty=ltys[i])

# add legend
legend("topright", colnames(data2plot),  
       col=cols, lty=ltys, cex=0.75, 
       border ="blue",  text.col = "green4", 
       merge = TRUE, bg = "gray90")
```

## Apply TMM normalization
```{r, message = FALSE, tidy=TRUE}
filteredData <-as.matrix(expDataFiltered[,2:32])
rownames(filteredData) <- expDataFiltered$ID
d <- edgeR::DGEList(counts=filteredData, group=samples$patients_group)
```

## Calculate the normalization factor
```{r, message = FALSE, tidy=TRUE}
d <- calcNormFactors(d)
expDataNorm <- cpm(d)
```

## MDS plot

Green = CON, Blue = MS

```{r eval=TRUE}
edgeR::plotMDS.DGEList(d, labels=rownames(samples),
  col = patientGroup)
```

# Task 4: Interpret, and document.

What are the control and test conditions of the dataset?
Why is the dataset of interest to you?
Were there expression values that were not unique for specific genes?
How did you handle these?
Were there expression values that could not be mapped to current HUGO symbols?
How many outliers were removed?
How did you handle replicates?
What is the final coverage of your dataset?
